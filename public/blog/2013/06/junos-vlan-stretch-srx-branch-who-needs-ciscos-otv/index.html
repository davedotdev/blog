<!DOCTYPE html>
<html class="no-js" lang="en-us"><head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="Stetched VLANs with Junos and Branch SRX">

<meta name="generator" content="Hugo 0.83.1" />

<title>Welcome to dave.dev</title>

<!-- Mobile Specific Meta -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Favicon -->
<link rel="shortcut icon" type="image/x-icon" href="https://dave.dev/images/favicon.ico" />

<!-- Stylesheets -->
<!-- Themefisher Icon font -->
<link rel="stylesheet" href="https://dave.dev/plugins/themefisher-font/style.css">
<!-- bootstrap.min css -->
<link rel="stylesheet" href="https://dave.dev/plugins/bootstrap/dist/css/bootstrap.min.css">
<!-- Lightbox.min css -->
<link rel="stylesheet" href="https://dave.dev/plugins/lightbox2/dist/css/lightbox.min.css">
<!-- Slick Carousel -->
<link rel="stylesheet" href="https://dave.dev/plugins/slick-carousel/slick/slick.css">
<link rel="stylesheet" href="https://dave.dev/plugins/slick-carousel/slick/slick-theme.css">
<!-- Main Stylesheet -->


<link rel="stylesheet" href="https://dave.dev/css/style.min.css" integrity="" media="screen">

<!-- Essential Scripts -->

<!-- jQuery -->
<script src="https://dave.dev/plugins/jquery/jquery-1.12.4.js"></script>
<!-- Bootstrap -->
<script src="https://dave.dev/plugins/bootstrap/dist/js/popper.min.js"></script>
<script src="https://dave.dev/plugins/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- Parallax -->
<script src="https://dave.dev/plugins/parallax/jquery.parallax-1.1.3.js"></script>
<!-- lightbox -->
<script src="https://dave.dev/plugins/lightbox2/dist/js/lightbox.min.js"></script>
<!-- Slick Carousel -->
<script src="https://dave.dev/plugins/slick-carousel/slick/slick.min.js"></script>
<!-- Portfolio Filtering -->
<script src="https://dave.dev/plugins/filterzr/jquery.filterizr.min.js"></script>
<!-- Smooth Scroll js -->
<script src="https://dave.dev/plugins/smooth-scroll/dist/js/smooth-scroll.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCC72vZw-6tGqFyRhhg5CkF2fqfILn2Tsw"></script>
<!-- Main Script -->

<script src="https://dave.dev/js/script.min.js"></script>

<!-- jquery ui -->
<script src="https://dave.dev/plugins/jquery/jquery-ui.js"></script>

<!-- match-height JS -->
<script src="https://dave.dev/plugins/match-height/jquery.matchHeight-min.js"></script>

</head>
<body id="body">
        <!-- Start Preloader -->
<div id="preloader">
    <div class="preloader">
        <div class="sk-circle1 sk-child"></div>
        <div class="sk-circle2 sk-child"></div>
        <div class="sk-circle3 sk-child"></div>
        <div class="sk-circle4 sk-child"></div>
        <div class="sk-circle5 sk-child"></div>
        <div class="sk-circle6 sk-child"></div>
        <div class="sk-circle7 sk-child"></div>
        <div class="sk-circle8 sk-child"></div>
        <div class="sk-circle9 sk-child"></div>
        <div class="sk-circle10 sk-child"></div>
        <div class="sk-circle11 sk-child"></div>
        <div class="sk-circle12 sk-child"></div>
    </div>
</div>
<!-- End Preloader --><!-- Fixed Navigation -->


<section class="header navigation">

    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <nav class="navbar navbar-expand-md">
                    <a class="navbar-brand" href="https://dave.dev/"><h2><font color=#ffffff>dave</font><font color=#ff813f>.</font>dev</h2>
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
                        aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="tf-ion-android-menu"></span>
                    </button>
                    
                    <div id="drapeaux">
                        
                        
                    </div>
                    <div class="collapse navbar-collapse" id="navigation">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link"
                                    href="https://dave.dev/"></a>
                            </li>
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/blog">Blog</a>
                            </li>
                            
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/graphops">GraphOps</a>
                            </li>
                            
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/portfolio">Portfolio</a>
                            </li>
                            
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/list">Full List</a>
                            </li>
                            
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/uijourney">My UI Journey</a>
                            </li>
                            
                            
                            <li class="nav-item">
                               <a class="nav-link" href="https://dave.dev/index.xml"><img alt="RSS" src="https://dave.dev/images/rss.png" width="25" height="25"></a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</section>
<div id="content">



<!-- React & JSX -->
<script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>

<section class="blog-single section">
    <div class="container">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <img src="https://dave.dev/images/blog/placeholder.jpg" class="w-100 mb-3" alt="Post-Image">
                <h2>Junos Stretch VLAN Using SRX Branch – who needs Cisco’s OTV?</h2>
                <div class="post-meta mb-5">
                    <ul class="list-inline">
                        <li class="list-inline-item">
                            <span>By</span>
                            <font color=#ff813f>David Gee</font>
                        </li>
                        <li class="list-inline-item">
                            <span>at</span>
                            <span><font color=#ff813f>June 18, 2013</font></span>
                        </li>
                    </ul>
                </div>
                <p>Traditional and modern Enterprises often suffer from inflexible service providers either charging over the odds, taking forever to make changes, or providing overly complex and unreliable services. SDN is beginning to threaten the way things are done in the data centre and enterprise, moving all the complexity up to a different level. The dawn of the Overlay and Underlay networks is here. Simple flat L2 and hardware switched L3 networks are pretty much the only requirement for SDN based networks, with a few exceptions, the edge being one of them. In terms of the traditional campus design methodology, WAN and internet connectivity modules will *always be required. Service Providers will always try and monetize and generate additional revenues from old tired featureless equipment. The problem for the lazy providers is the rest of the world has got smarter. What was once bleeding edge tech, is now mature, predictable and part of network consultants and engineers day to day tool set.</p>
<p>Recently a requirement was raised to stretch a L2 VLAN between two customer sites that are connected via a typical L3 MPLS VPN service. Just to clarify here, this results in a simple L3 network and the customer does not interact with MPLS itself (sorry, I have seen CV’s from people claiming to have MPLS experience. This is not MPLS exposure. Just L3!). The requirement more specifically was to stretch L2 between two L3 connected sites to provide seamless migration of virtual machines. In a mature IT department, many physical servers underwent virtual consolidation in round one of VMware’s onslaught a long time ago (in IT years). Under rebuild scenarios, the servers would get built and each software service would get scrutinized. Old unused services would get removed and used services would get upgraded or patched. When P2V occurs, there isn’t (without a good reason) a need to rip apart known working machines, so a state is reached where departments do not have deep knowledge as to what is running where on what. Stretching a VLAN and migrating the virtual machines between two different data centres allows for some shy eyes during a stressful migration processes. So, how do you do this when presented with a L3 network? Straight away, a Cisco house running traditional IOS based devices would push for L2TPv3, which works. Create a L2 tunnel. Job done. If you have ever tried implementing L2TPv3 tunnels, you will know either you have to introduce extra equipment (depending on current model of router or performance requirements etc.), or cable up additional ports in order to bridge from a LAN/VLAN to the port which is configured as an ‘xconnect’, in some instances on the same line card or switch. Nexus7K devices provide OTV which will provide the DCI in this instance, but OTV comes with its own topological requirements (and hefty price tag).</p>
<p>Here are the requirements with more detail:</p>
<p>a)  L2 Stretch between two DC’s over pure L3 network</p>
<p>b)  No changes to provider network to avoid cost</p>
<p>c)  Cannot install an additional WAN circuit</p>
<p>d)  Try and avoid installing additional kit</p>
<p>e)  No interruption to current traffic flows</p>
<p>f)  Avoid kludges<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<p>g)  Prepared to sacrifice some MTU headroom</p>
<p>I add at this point, the current network is running Juniper SRX210’s as the CPE device which replaced previous J series devices. These are running in packet forwarding mode with future plans to make them flow based post migration.</p>
<p>Can this be done with the SRX210’s alone? Absolutely. Does it perform? You bet. Does it break sweat? Not really. Do you need extra cabling? Nope.</p>
<p>Juniper are known for superiority in the Service Provider space and all things MPLS. If you’ve read any other articles on this site, you will know I love Junos. Its flexibility astounds me and their vision of the future has me excited. In this instance, Junos provides an elegant way to meet the requirements and also provide local internet breakout at each site with first hop resiliency for ingress and egress of the stretched LAN/VLAN. With some scripting and RPM usage, you could also add features like auto failover just in case the internet uplink died or became unavailable. Cool stuff.</p>
<p>The solution is based on VPLSoGRE with VRRP used for the FHRP. This would also be possible with AToM (Any Traffic over MPLS) using a L2CKT, Ethernet or VLAN circuit cross connect (CCC), but I went with VPLS as I like to build scalable topologies. With the Juniper MX, this would be a straight forward design to implement. You would create an irb group (integrated routing and bridging) and add the interfaces in to the VPLS instance. The SRX branch products do not support irb when used in this way (as I found out when trying to configure it!). So how do you do it? The trick I found was to use logical tunnel interfaces (<code>lt-0/0/0</code>) in addition to running VRRP between each peer logical-tunnel unit that sits in the global routing table on each device. Who’d of thunk it?</p>
<p>Before I dive in to the configuration, we need to take a brief look at the MTU side effect. With MPLSoGRE, if we assume 1500byte starting IP MTU for the WAN circuit, we can deduct another 24 bytes for GRE (20 bytes for the new IP header, plus 4 bytes for the GRE header without any other GRE mechanisms) and 8 bytes for 2x MPLS labels (more on that shortly). So we’ve reduced the MTU to 1500 – (24+8) = 1464 bytes before fragmentation is required. Whilst I’ve seen worse MTU on consumer broadband, in an enterprise or data centre environment, it’s worth investigating just how big the packets are moving between those VM’s and hosts in the same VLAN as fragmentation can and will have an effect on CPU load.</p>
<p>Not that it’s hard to picture, below is an image which represents the test environment. You might have to click on the image in order to view the detail. One of the problems from having a narrow blog!</p>
<p><img src="/images/blog/VPLSoGREwithGateways.png#center" alt="VPLSoGREwithGateways"></p>
<p>As a summary, each device participates in OSPFv3 which also has the IPv6 realm knob configured so that we can use just one IGP for both IPv4 and IPv6. For the sake of simplicity, all direct and local routes are redistributed into the OSPFv3 process, which means end-to-end connectivity is in place between each device. This means each device can ping every other device via its loopback and point-to-point interface. Between each SRX210, a GRE tunnel is nailed up, BGP is configured to work with the ‘l2vpn’ family, which provides signalling for VPLS end points and LDP finishes the story off by providing the label swapping mechanism. You can of course configure this topology without BGP, but adding hosts can become cumbersome. BGP configured in this way advertises the location of VPLS endpoints for LDP to automatically target. In larger networks, it is wise to use a pair of BGP route-reflectors, else scaling again becomes an issue as everything is considered point-to-point without the RR’s. When trying to build anything like this, from a high level view, what you’re actually doing is fully meshing the control-plane and the data-plane with BGP and LDP respectively.</p>
<p>There are various show commands that can be submitted to each device to prove the correct operation of each protocol. SRX1 is the bottom left hand side SRX210, SRX2 is the SRX210 on the bottom right hand side device. SRX3 and SRX4 are the top left and top right SRX devices respectively.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@SRX1# run show ldp session detail
Address: 2.2.2.2, State: Operational, Connection: Open, Hold time: <span style="color:#ae81ff">24</span>
Session ID: 1.1.1.1:0--2.2.2.2:0
Next keepalive in <span style="color:#ae81ff">4</span> seconds
Passive, Maximum PDU: 4096, Hold time: 30, Neighbor count: <span style="color:#ae81ff">1</span>
Neighbor types: discovered
Keepalive interval: 10, Connect retry interval: <span style="color:#ae81ff">1</span>
Local address: 1.1.1.1, Remote address: 2.2.2.2
Up <span style="color:#66d9ef">for</span> 09:20:09
Capabilities advertised: none
Capabilities received: none
Protection: disabled
Local - Restart: disabled, Helper mode: enabled
Remote - Restart: disabled, Helper mode: enabled
Local maximum neighbor reconnect time: <span style="color:#ae81ff">120000</span> msec
Local maximum neighbor recovery time: <span style="color:#ae81ff">240000</span> msec
Nonstop routing state: Not in sync
Next-hop addresses received:
gr-0/0/0.0
172.16.0.2


root@SRX2# run show ldp session detail
Address: 1.1.1.1, State: Operational, Connection: Open, Hold time: <span style="color:#ae81ff">29</span>
Session ID: 2.2.2.2:0--1.1.1.1:0
Next keepalive in <span style="color:#ae81ff">9</span> seconds
Active, Maximum PDU: 4096, Hold time: 30, Neighbor count: <span style="color:#ae81ff">1</span>
Neighbor types: discovered
Keepalive interval: 10, Connect retry interval: <span style="color:#ae81ff">1</span>
Local address: 2.2.2.2, Remote address: 1.1.1.1
Up <span style="color:#66d9ef">for</span> 09:20:23
Capabilities advertised: none
Capabilities received: none
Protection: disabled
Local - Restart: disabled, Helper mode: enabled
Remote - Restart: disabled, Helper mode: enabled
Local maximum neighbor reconnect time: <span style="color:#ae81ff">120000</span> msec
Local maximum neighbor recovery time: <span style="color:#ae81ff">240000</span> msec
Nonstop routing state: Not in sync
Next-hop addresses received:
gr-0/0/0.0
172.16.0.1


root@SRX1# run show ldp database
Input label database, 1.1.1.1:0--2.2.2.2:0
Label Prefix
<span style="color:#ae81ff">299776</span> 1.1.1.1/32
<span style="color:#ae81ff">3</span> 2.2.2.2/32

Output label database, 1.1.1.1:0--2.2.2.2:0
Label Prefix
<span style="color:#ae81ff">3</span> 1.1.1.1/32
<span style="color:#ae81ff">299776</span> 2.2.2.2/32


root@SRX2# run show ldp database
Input label database, 2.2.2.2:0--1.1.1.1:0
Label Prefix
<span style="color:#ae81ff">3</span> 1.1.1.1/32
<span style="color:#ae81ff">299776</span> 2.2.2.2/32

Output label database, 2.2.2.2:0--1.1.1.1:0
Label Prefix
<span style="color:#ae81ff">299776</span> 1.1.1.1/32
<span style="color:#ae81ff">3</span> 2.2.2.2/32


root@SRX1# run show vpls connection
Instance: VPLS
  BGP-VPLS State
  Local site: R1 <span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>
    connection-site           Type  St     Time last up          <span style="color:#75715e"># Up trans</span>
    <span style="color:#ae81ff">2</span>                         rmt   Up     Jun <span style="color:#ae81ff">18</span> 16:29:50 <span style="color:#ae81ff">2013</span>           <span style="color:#ae81ff">1</span>
      Remote PE: 2.2.2.2, Negotiated control-word: No
      Incoming label: 262146, Outgoing label: <span style="color:#ae81ff">262145</span>
      Local interface: lsi.1048576, Status: Up, Encapsulation: VPLS
        Description: Intf - vpls VPLS local site <span style="color:#ae81ff">1</span> remote site <span style="color:#ae81ff">2</span>
  LDP-VPLS State
  VPLS-id: <span style="color:#ae81ff">600</span>


root@SRX2# run show vpls connection
Instance: VPLS
  BGP-VPLS State
  Local site: R2 <span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>
    connection-site           Type  St     Time last up          <span style="color:#75715e"># Up trans</span>
    <span style="color:#ae81ff">1</span>                         rmt   Up     Jun <span style="color:#ae81ff">18</span> 16:25:54 <span style="color:#ae81ff">2013</span>           <span style="color:#ae81ff">1</span>
      Remote PE: 1.1.1.1, Negotiated control-word: No
      Incoming label: 262145, Outgoing label: <span style="color:#ae81ff">262146</span>
      Local interface: lsi.1048576, Status: Up, Encapsulation: VPLS
        Description: Intf - vpls VPLS local site <span style="color:#ae81ff">2</span> remote site <span style="color:#ae81ff">1</span>
  LDP-VPLS State
  VPLS-id: <span style="color:#ae81ff">600</span>


root@SRX1# run show bgp neighbor
Peer: 2.2.2.2+63588 AS <span style="color:#ae81ff">56518</span>   Local: 1.1.1.1+179 AS <span style="color:#ae81ff">56518</span>
  Type: Internal    State: Established    Flags: 
  Last State: OpenConfirm   Last Event: RecvKeepAlive
  Last Error: None
  Options: 
  Address families configured:  l2vpn-signaling
  Local Address: 1.1.1.1 Holdtime: <span style="color:#ae81ff">90</span> Preference: <span style="color:#ae81ff">170</span>
  Number of flaps: <span style="color:#ae81ff">0</span>
  Peer ID: 2.2.2.2         Local ID: 1.1.1.1           Active Holdtime: <span style="color:#ae81ff">90</span>
  Keepalive Interval: <span style="color:#ae81ff">30</span>         Peer index: <span style="color:#ae81ff">0</span>
  BFD: disabled, down
  NLRI <span style="color:#66d9ef">for</span> restart configured on peer: l2vpn
  NLRI advertised by peer: l2vpn
  NLRI <span style="color:#66d9ef">for</span> this session: l2vpn
  Peer supports Refresh capability <span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>
  Stale routes from peer are kept <span style="color:#66d9ef">for</span>: <span style="color:#ae81ff">300</span>
  Peer does not support Restarter functionality
  NLRI that restart is negotiated <span style="color:#66d9ef">for</span>: l2vpn
  NLRI of received end-of-rib markers: l2vpn
  NLRI of all end-of-rib markers sent: l2vpn
  Peer supports <span style="color:#ae81ff">4</span> byte AS extension <span style="color:#f92672">(</span>peer-as 56518<span style="color:#f92672">)</span>
  Peer does not support Addpath
  Table bgp.l2vpn.0
    RIB State: BGP restart is complete
    RIB State: VPN restart is complete
    Send state: not advertising
    Active prefixes:              <span style="color:#ae81ff">1</span>
    Received prefixes:            <span style="color:#ae81ff">1</span>
    Accepted prefixes:            <span style="color:#ae81ff">1</span>
    Suppressed due to damping:    <span style="color:#ae81ff">0</span>
  Table VPLS.l2vpn.0 Bit: <span style="color:#ae81ff">20000</span>
    RIB State: BGP restart is complete
    RIB State: VPN restart is complete
    Send state: in sync
    Active prefixes:              <span style="color:#ae81ff">1</span>
    Received prefixes:            <span style="color:#ae81ff">1</span>
    Accepted prefixes:            <span style="color:#ae81ff">1</span>
    Suppressed due to damping:    <span style="color:#ae81ff">0</span>
    Advertised prefixes:          <span style="color:#ae81ff">1</span>
  Last traffic <span style="color:#f92672">(</span>seconds<span style="color:#f92672">)</span>: Received <span style="color:#ae81ff">24</span>   Sent <span style="color:#ae81ff">10</span>   Checked <span style="color:#ae81ff">43</span>
  Input messages:  Total <span style="color:#ae81ff">56</span>     Updates <span style="color:#ae81ff">2</span>       Refreshes <span style="color:#ae81ff">0</span>     Octets <span style="color:#ae81ff">1184</span>
  Output messages: Total <span style="color:#ae81ff">57</span>     Updates <span style="color:#ae81ff">1</span>       Refreshes <span style="color:#ae81ff">0</span>     Octets <span style="color:#ae81ff">1222</span>
  Output Queue<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>: <span style="color:#ae81ff">0</span>
  Output Queue<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: <span style="color:#ae81ff">0</span>



root@SRX1# run show route table VPLS.l2vpn.0
VPLS.l2vpn.0: <span style="color:#ae81ff">2</span> destinations, <span style="color:#ae81ff">2</span> routes <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> active, <span style="color:#ae81ff">0</span> holddown, <span style="color:#ae81ff">0</span> hidden<span style="color:#f92672">)</span>
+ <span style="color:#f92672">=</span> Active Route, - <span style="color:#f92672">=</span> Last Active, * <span style="color:#f92672">=</span> Both

1.1.1.1:600:1:1/96
                   *<span style="color:#f92672">[</span>L2VPN/170/-101<span style="color:#f92672">]</span> 00:37:52, metric2 <span style="color:#ae81ff">1</span>
                      Indirect
1.1.1.1:600:2:1/96
                   *<span style="color:#f92672">[</span>BGP/170<span style="color:#f92672">]</span> 00:36:17, localpref 100, from 2.2.2.2
                      AS path: I
                    &amp;gt; to 172.16.0.2 via gr-0/0/0.0


root@SRX2# run show bgp neighbor
Peer: 1.1.1.1+179 AS <span style="color:#ae81ff">56518</span>     Local: 2.2.2.2+63588 AS <span style="color:#ae81ff">56518</span>
  Type: Internal    State: Established    Flags: 
  Last State: OpenConfirm   Last Event: RecvKeepAlive
  Last Error: None
  Options: 
  Address families configured:  l2vpn-signaling
  Local Address: 2.2.2.2 Holdtime: <span style="color:#ae81ff">90</span> Preference: <span style="color:#ae81ff">170</span>
  Number of flaps: <span style="color:#ae81ff">0</span>
  Peer ID: 1.1.1.1         Local ID: 2.2.2.2           Active Holdtime: <span style="color:#ae81ff">90</span>
  Keepalive Interval: <span style="color:#ae81ff">30</span>         Peer index: <span style="color:#ae81ff">0</span>
  BFD: disabled, down
  NLRI <span style="color:#66d9ef">for</span> restart configured on peer: l2vpn
  NLRI advertised by peer: l2vpn
  NLRI <span style="color:#66d9ef">for</span> this session: l2vpn
  Peer supports Refresh capability <span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>
  Stale routes from peer are kept <span style="color:#66d9ef">for</span>: <span style="color:#ae81ff">300</span>
  Peer does not support Restarter functionality
  NLRI that restart is negotiated <span style="color:#66d9ef">for</span>: l2vpn
  NLRI of received end-of-rib markers: l2vpn
  NLRI of all end-of-rib markers sent: l2vpn
  Peer supports <span style="color:#ae81ff">4</span> byte AS extension <span style="color:#f92672">(</span>peer-as 56518<span style="color:#f92672">)</span>
  Peer does not support Addpath
  Table bgp.l2vpn.0
    RIB State: BGP restart is complete
    RIB State: VPN restart is complete
    Send state: not advertising
    Active prefixes:              <span style="color:#ae81ff">1</span>
    Received prefixes:            <span style="color:#ae81ff">1</span>
    Accepted prefixes:            <span style="color:#ae81ff">1</span>
    Suppressed due to damping:    <span style="color:#ae81ff">0</span>
  Table VPLS.l2vpn.0 Bit: <span style="color:#ae81ff">20000</span>
    RIB State: BGP restart is complete
    RIB State: VPN restart is complete
    Send state: in sync
    Active prefixes:              <span style="color:#ae81ff">1</span>
    Received prefixes:            <span style="color:#ae81ff">1</span>
    Accepted prefixes:            <span style="color:#ae81ff">1</span>
    Suppressed due to damping:    <span style="color:#ae81ff">0</span>
    Advertised prefixes:          <span style="color:#ae81ff">1</span>
  Last traffic <span style="color:#f92672">(</span>seconds<span style="color:#f92672">)</span>: Received <span style="color:#ae81ff">27</span>   Sent <span style="color:#ae81ff">12</span>   Checked <span style="color:#ae81ff">76</span>
  Input messages:  Total <span style="color:#ae81ff">56</span>     Updates <span style="color:#ae81ff">2</span>       Refreshes <span style="color:#ae81ff">0</span>     Octets <span style="color:#ae81ff">1144</span>
  Output messages: Total <span style="color:#ae81ff">57</span>     Updates <span style="color:#ae81ff">1</span>       Refreshes <span style="color:#ae81ff">0</span>     Octets <span style="color:#ae81ff">1222</span>
  Output Queue<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>: <span style="color:#ae81ff">0</span>
  Output Queue<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: <span style="color:#ae81ff">0</span>


root@SRX2# run show route table VPLS.l2vpn.0
VPLS.l2vpn.0: <span style="color:#ae81ff">2</span> destinations, <span style="color:#ae81ff">2</span> routes <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> active, <span style="color:#ae81ff">0</span> holddown, <span style="color:#ae81ff">0</span> hidden<span style="color:#f92672">)</span>
+ <span style="color:#f92672">=</span> Active Route, - <span style="color:#f92672">=</span> Last Active, * <span style="color:#f92672">=</span> Both

1.1.1.1:600:1:1/96
                   *<span style="color:#f92672">[</span>BGP/170<span style="color:#f92672">]</span> 00:36:23, localpref 100, from 1.1.1.1
                      AS path: I
                    &amp;gt; to 172.16.0.1 via gr-0/0/0.0
1.1.1.1:600:2:1/96
                   *<span style="color:#f92672">[</span>L2VPN/170/-101<span style="color:#f92672">]</span> 00:38:38, metric2 <span style="color:#ae81ff">1</span>
                      Indirect
</code></pre></div><p>Clearly above you can see that the LDP sessions are up and running and the VPLS connections are established. I’ve left off the route table output as that’s self explanatory. Finally, with the SRX devices, the <code>show vpls mac-table</code> command doesn’t work. You have to use <code>show route forwarding-table family vpls</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@SRX1# run show route forwarding-table family vpls
Routing table: VPLS.vpls
VPLS:
Destination Type RtRef Next hop Type Index NhRef Netif
default perm <span style="color:#ae81ff">0</span> rjct <span style="color:#ae81ff">542</span> <span style="color:#ae81ff">1</span>
ge-0/0/0.0 user <span style="color:#ae81ff">0</span> comp <span style="color:#ae81ff">566</span> <span style="color:#ae81ff">3</span>
lt-0/0/0.0 user <span style="color:#ae81ff">0</span> comp <span style="color:#ae81ff">566</span> <span style="color:#ae81ff">3</span>
lsi.1048576 user <span style="color:#ae81ff">0</span> comp <span style="color:#ae81ff">589</span> <span style="color:#ae81ff">2</span>
00:00:5e:00:01:0a/48 dynm <span style="color:#ae81ff">0</span> indr <span style="color:#ae81ff">262142</span> <span style="color:#ae81ff">6</span>
Push <span style="color:#ae81ff">262145</span> <span style="color:#ae81ff">585</span> <span style="color:#ae81ff">2</span> gr-0/0/0.0
60:fb:42:f5:e0:0e/48 dynm <span style="color:#ae81ff">0</span> ucst <span style="color:#ae81ff">577</span> <span style="color:#ae81ff">3</span> ge-0/0/0.0
70:5a:b6:b0:31:ab/48 dynm <span style="color:#ae81ff">0</span> indr <span style="color:#ae81ff">262142</span> <span style="color:#ae81ff">6</span>
Push <span style="color:#ae81ff">262145</span> <span style="color:#ae81ff">585</span> <span style="color:#ae81ff">2</span> gr-0/0/0.0
78:19:f7:aa:32:40/48 perm <span style="color:#ae81ff">0</span> ucst <span style="color:#ae81ff">563</span> <span style="color:#ae81ff">1</span> lt-0/0/0.0
78:19:f7:aa:52:80/48 dynm <span style="color:#ae81ff">0</span> indr <span style="color:#ae81ff">262142</span> <span style="color:#ae81ff">6</span>
Push <span style="color:#ae81ff">262145</span> <span style="color:#ae81ff">585</span> <span style="color:#ae81ff">2</span> gr-0/0/0.0

root@SRX2# run show route forwarding-table family vpls
Routing table: VPLS.vpls
VPLS:
Destination Type RtRef Next hop Type Index NhRef Netif
default perm <span style="color:#ae81ff">0</span> rjct <span style="color:#ae81ff">542</span> <span style="color:#ae81ff">1</span>
ge-0/0/0.0 user <span style="color:#ae81ff">0</span> comp <span style="color:#ae81ff">570</span> <span style="color:#ae81ff">3</span>
lt-0/0/0.0 user <span style="color:#ae81ff">0</span> comp <span style="color:#ae81ff">570</span> <span style="color:#ae81ff">3</span>
lsi.1048576 user <span style="color:#ae81ff">0</span> comp <span style="color:#ae81ff">589</span> <span style="color:#ae81ff">2</span>
00:00:5e:00:01:0a/48 dynm <span style="color:#ae81ff">0</span> ucst <span style="color:#ae81ff">563</span> <span style="color:#ae81ff">2</span> lt-0/0/0.0
60:fb:42:f5:e0:0e/48 dynm <span style="color:#ae81ff">0</span> indr <span style="color:#ae81ff">262142</span> <span style="color:#ae81ff">5</span>
Push <span style="color:#ae81ff">262146</span> <span style="color:#ae81ff">585</span> <span style="color:#ae81ff">2</span> gr-0/0/0.0
70:5a:b6:b0:31:ab/48 dynm <span style="color:#ae81ff">0</span> ucst <span style="color:#ae81ff">577</span> <span style="color:#ae81ff">3</span> ge-0/0/0.0
78:19:f7:aa:32:40/48 dynm <span style="color:#ae81ff">0</span> indr <span style="color:#ae81ff">262142</span> <span style="color:#ae81ff">5</span>
Push <span style="color:#ae81ff">262146</span> <span style="color:#ae81ff">585</span> <span style="color:#ae81ff">2</span> gr-0/0/0.0
78:19:f7:aa:52:80/48 perm <span style="color:#ae81ff">0</span> ucst <span style="color:#ae81ff">563</span> <span style="color:#ae81ff">2</span> lt-0/0/0.0
</code></pre></div><p>The configurations for this lab are in downloadable format below. Please feel free to download them!</p>
<p>Finally, just to prove this works (as much as you can believe any image in this day and age), below shows one of my test targets pinging each lt-0/0/0 inet address and the adjacent test host.</p>
<p><img src="/images/blog/VPLS_Stretched_Host_Pings.png#center" alt="VPLS_Stretched_Host_Pings"></p>
<p>I’ve also tested this network under load using D-ITG with varying packet sizes and bursts. It performs superbly well. With some CoS config, it would be wise to put some safe guards in, but even using the smallest SRX devices, you can max out 100Mbps links without stressing the devices.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Kludge Avoidance: No weird cabling arrangements, No looping ports together on the same switch/line card, Avoid unreliable configuration.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>



                
        <p><i><b>Dave</b></i></p>
    
        <ul class="list-inline">
            <li>
                <span>Tags:</span>
                <span><font color=#ff813f></font></span>
            </li>
            <li>
                <span>Categories:</span>
                <span><font color=#ff813f></font></span>
            </li>
        </ul>
            </div>
        </div>
    </div>
</section>


        </div><!-- Footer Start -->
<footer id="footer" class="bg-one">
    <div class="top-footer">
        <div class="container">
            <div class="row">
                <div class="col-sm-3 col-md-3 col-lg-3">
		    <h3>Email Me</h3>
		    <a href="mailto:me@dave.dev">me@dave.dev</a>
		</div>
                <div class="col-sm-3 col-md-3 col-lg-3">
                    <h3>Social Links</h3>
                    <div class="social-icon">
                    <ul class="list-inline social-icon">
                        
                        
                        <li class="list-inline-item">
                            <a href="https://twitter.com/_ipengineer">
                                <i class="tf-ion-social-twitter"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://www.linkedin.com/in/lsp42/">
                                <i class="tf-ion-social-linkedin"></i>
                            </a>
                        </li>
                        
                        
                        
                        
                        <li class="list-inline-item">
                            <a href="https://github.com/davidjohngee">
                                <i class="tf-ion-social-github"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://github.com/arsonistgopher">
                                <i class="tf-ion-social-github"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://github.com/davedotdev">
                                <i class="tf-ion-social-github"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://hub.docker.com/u/davedotdev">
                                <i class="tf-ion-code-download"></i>
                            </a>
                        </li>
                        

                    </ul>
                    </div>
                </div>
                <div class="col-sm-3 col-md-3 col-lg-3">
                    <h3>Treat the Author</h3>
		        <a href="https://www.buymeacoffee.com/ipengineer"><img border="0" alt="Buy me a coffee!" src="/images/bmac.png"></a>
                </div>
                <div class="col-sm-3 col-md-3 col-lg-3">
                    <h3>Copyright</h3>
                    <p><font color=#ff813f>© David Gee and dave.dev, 2021.</font></p>
                </div>

                
                
                
                

            </div>
        </div>
    </div>
</footer>
<!-- end footer -->



</body>
</html>
