<!DOCTYPE html>
<html class="no-js" lang="en-us"><head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="Python: Real World Hacking on StackStorm (Network Engineer Focussed)">

<meta name="generator" content="Hugo 0.62.0-DEV" />

<title>Welcome to dave.dev</title>

<!-- Mobile Specific Meta -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Favicon -->
<link rel="shortcut icon" type="image/x-icon" href="https://dave.dev/images/favicon.ico" />

<!-- Stylesheets -->
<!-- Themefisher Icon font -->
<link rel="stylesheet" href="https://dave.dev/plugins/themefisher-font/style.css">
<!-- bootstrap.min css -->
<link rel="stylesheet" href="https://dave.dev/plugins/bootstrap/dist/css/bootstrap.min.css">
<!-- Lightbox.min css -->
<link rel="stylesheet" href="https://dave.dev/plugins/lightbox2/dist/css/lightbox.min.css">
<!-- Slick Carousel -->
<link rel="stylesheet" href="https://dave.dev/plugins/slick-carousel/slick/slick.css">
<link rel="stylesheet" href="https://dave.dev/plugins/slick-carousel/slick/slick-theme.css">
<!-- Main Stylesheet -->


<link rel="stylesheet" href="https://dave.dev/css/style.min.css" integrity="" media="screen">

</head>
<body id="body">
        <!-- Start Preloader -->
<div id="preloader">
    <div class="preloader">
        <div class="sk-circle1 sk-child"></div>
        <div class="sk-circle2 sk-child"></div>
        <div class="sk-circle3 sk-child"></div>
        <div class="sk-circle4 sk-child"></div>
        <div class="sk-circle5 sk-child"></div>
        <div class="sk-circle6 sk-child"></div>
        <div class="sk-circle7 sk-child"></div>
        <div class="sk-circle8 sk-child"></div>
        <div class="sk-circle9 sk-child"></div>
        <div class="sk-circle10 sk-child"></div>
        <div class="sk-circle11 sk-child"></div>
        <div class="sk-circle12 sk-child"></div>
    </div>
</div>
<!-- End Preloader --><!-- Fixed Navigation -->


<section class="header navigation">

    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <nav class="navbar navbar-expand-md">
                    <a class="navbar-brand" href="https://dave.dev/">
                        <img src="https://dave.dev/images/logo2.png" alt="logo">
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
                        aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="tf-ion-android-menu"></span>
                    </button>
                    
                    <div id="drapeaux">
                        
                        
                    </div>
                    <div class="collapse navbar-collapse" id="navigation">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link"
                                    href="https://dave.dev/"></a>
                            </li>
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/blog">Blog</a>
                            </li>
                            
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/portfolio">Portfolio</a>
                            </li>
                            
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/list">Full List</a>
                            </li>
                            
                            
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</section><div id="content">

<section class="blog-single section">
    <div class="container">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <img src="https://dave.dev/images/blog/placeholder.jpg" class="w-100 mb-3" alt="Post-Image">
                <h2>Python: Real World Hacking on StackStorm (Network Engineer Focussed)</h2>
                <div class="post-meta mb-5">
                    <ul class="list-inline">
                        <li class="list-inline-item">
                            <span>By</span>
                            David Gee
                        </li>
                        <li class="list-inline-item">
                            <span>at</span>
                            <span>February 27, 2017</span>
                        </li>
                    </ul>
                </div>
                <p><img src="/images/blog/st2_stackstorm.jpg#center" alt="ST2"></p>
<p>It’s miserably cold, raining (the kind that gets you really wet) and a strange dark grey light covers the UK. Some would say a typical day on this island. That said, I have a coffee in hand and some thoughts to share!</p>
<p>For the last year working for Brocade, I’ve been heavily focussed on delivering talks, demonstrations and knowledge on the excellent StackStorm open-source project (referred to as ST2 from this point onwards for brevity). This post does not go in to what ST2 is, but for those who don’t know, it’s an event driven workflow engine. Input, decision/s, output. Simple! The ST2 website itself is a great resource for information as well as other well known blogs. ST2 is quite feature rich and under constant development. One would say it’s an agile tool for a growingly agile world.</p>
<h4 id="so-what-have-you-been-making">So What Have You Been Making?</h4>
<p>I can’t spoil what it is I’ve been building, but one of the challenges was to use the built in key-value (KV) store (currently built on Etcd with a ST2 specific abstraction layer) to use as a point of data convergence. What does this mean in real terms? I have multiple things happening and I want to use the KV store as a common point of reference to tie these things together. ST2 allows you to use the KV store in multiple ways:</p>
<p>In workflows via setting, getting, updating and deleting keys based on YAML and YAQL
Using the Python ‘st2client’ library which calls the ST2 REST API underneath
Directly using the ST2 REST API
For my specific use case, I want to access the ST2 KV store over the ST2 REST API and carry out operations using the st2client Python library on a virtual machine <em>not</em> on the ST2 base host. The documentation is a great starting point but with all things development, my use case is my use case and we can’t expect documentation to exist for every imaginable thing! After all, I’m not a narcissistic psychopath (or am I?).</p>
<p>Before we start looking at the logic involved to achieve the ‘use case’, I’ve created a Ubuntu VM on 14.04. On this VM I’ll explore the st2client lib that’s used in the documentation and share all of the output so you can play along too!</p>
<p>On this VM, I’ve done the obligatory: <code>sudo apt-get update &amp;&amp; sudo apt-get upgrade</code>.
Next, <code>sudo pip install st2client</code> to install the client library we’ll be working with.</p>
<h4 id="the-hacking">The Hacking</h4>
<p>ST2 itself is fronted by <a href="https://www.nginx.com/">NGINX</a>, the well known HTTP server and reverse proxy and I happen to know that it handles SSL termination for ST2.</p>
<p><img src="/images/blog/StackStorm_NGINX.png#center" alt="StackStorm_NGINX"></p>
<p>hat means the example below directly taken from the documentation page is working on the ST2 host itself. See the ‘http’ below? If we were to try this on my test VM, what is the result? Let’s do this on the interactive Python shell for fun.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;&gt;&gt; from st2client.client import Client
&gt;&gt;&gt; from st2client.models import KeyValuePair
&gt;&gt;&gt; client <span style="color:#f92672">=</span> Client<span style="color:#f92672">(</span>base_url<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://192.168.16.20&#39;</span><span style="color:#f92672">)</span>
&gt;&gt;&gt; output <span style="color:#f92672">=</span> client.keys.get_all<span style="color:#f92672">(</span><span style="color:#f92672">)</span>
...&lt;snip&gt;
   raise ConnectionError<span style="color:#f92672">(</span>e<span style="color:#f92672">)</span>
requests.exceptions.ConnectionError: HTTPConnectionPool<span style="color:#f92672">(</span>host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;192.168.16.20&#39;</span>, port<span style="color:#f92672">=</span>9101<span style="color:#f92672">)</span>: Max retries exceeded with url: /v1/keys <span style="color:#f92672">(</span>Caused by &lt;class <span style="color:#e6db74">&#39;socket.error&#39;</span>&gt;: <span style="color:#f92672">[</span>Errno 111<span style="color:#f92672">]</span> Connection refused<span style="color:#f92672">)</span>
</code></pre></div><p>Notice the port above? Yep, it’s running on defaults and assuming it’s running local to the ST2 base installation. We can assume safely here the core developers have taken care of this and have included a method on the class that allows us to pass in a URL for the API.</p>
<p>So how do we find out where this helper might be? After all, we’ve tried passing in ‘https’ in to the Client constructor which made no difference.</p>
<p>We could start with the help() function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;&gt;&gt; help<span style="color:#f92672">(</span>client<span style="color:#f92672">)</span>
</code></pre></div><p>This was no help.</p>
<p>What about:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;&gt;&gt; help<span style="color:#f92672">(</span>client.keys<span style="color:#f92672">)</span>
</code></pre></div><p>Nope. We’re specifically looking for help on arguments we can pass to the Client() base class. The best place to look for that is the code itself.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;&gt;&gt; exit<span style="color:#f92672">(</span><span style="color:#f92672">)</span>
me@testvm:~$ pip show st2client
---
Name: st2client
Version: 2.2.0
Location: /usr/local/lib/python2.7/dist-packages
Requires: jsonpath-rw, prettytable, python-dateutil, pyyaml, requests, six
</code></pre></div><p>Ok, now we know where to look for our class. We’re specifically looking for information surrounding the client and something relating to an API end-point or URL.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">me<span style="color:#a6e22e">@testvm</span>:<span style="color:#f92672">~</span><span style="color:#960050;background-color:#1e0010">$</span> cat <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>local<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#f92672">.</span><span style="color:#ae81ff">7</span><span style="color:#f92672">/</span>dist<span style="color:#f92672">-</span>packages<span style="color:#f92672">/</span>st2client<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py
<span style="color:#75715e"># Licensed to the StackStorm, Inc (&#39;StackStorm&#39;) under one or more</span>
<span style="color:#75715e"># contributor license agreements.  See the NOTICE file distributed with</span>
<span style="color:#75715e"># this work for additional information regarding copyright ownership.</span>
<span style="color:#75715e"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span style="color:#75715e"># (the &#34;License&#34;); you may not use this file except in compliance with</span>
<span style="color:#75715e"># the License.  You may obtain a copy of the License at</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># Unless required by applicable law or agreed to in writing, software</span>
<span style="color:#75715e"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
<span style="color:#75715e"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="color:#75715e"># See the License for the specific language governing permissions and</span>
<span style="color:#75715e"># limitations under the License.</span>

<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> logging

<span style="color:#f92672">import</span> six

<span style="color:#f92672">from</span> st2client <span style="color:#f92672">import</span> models
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> ResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> ActionAliasResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> LiveActionResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> TriggerInstanceResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> PackResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> ConfigManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> StreamManager


LOG <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(__name__)

<span style="color:#75715e"># Default values for the options not explicitly specified by the user</span>
DEFAULT_API_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">9101</span>
DEFAULT_AUTH_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">9100</span>
DEFAULT_STREAM_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">9102</span>

DEFAULT_BASE_URL <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://127.0.0.1</span><span style="color:#e6db74">&#39;</span>
DEFAULT_API_VERSION <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">v1</span><span style="color:#e6db74">&#39;</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Client</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, base_url<span style="color:#f92672">=</span>None, auth_url<span style="color:#f92672">=</span>None, api_url<span style="color:#f92672">=</span>None, stream_url<span style="color:#f92672">=</span>None,
                 api_version<span style="color:#f92672">=</span>None, cacert<span style="color:#f92672">=</span>None, debug<span style="color:#f92672">=</span>False, token<span style="color:#f92672">=</span>None, api_key<span style="color:#f92672">=</span>None):
        <span style="color:#75715e"># Get CLI options. If not given, then try to get it from the environment.</span>
        self<span style="color:#f92672">.</span>endpoints <span style="color:#f92672">=</span> dict()

        <span style="color:#75715e"># Populate the endpoints</span>
        <span style="color:#66d9ef">if</span> base_url:
            self<span style="color:#f92672">.</span>endpoints[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">base</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> base_url
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>endpoints[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">base</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ST2_BASE_URL</span><span style="color:#e6db74">&#39;</span>, DEFAULT_BASE_URL)

        api_version <span style="color:#f92672">=</span> api_version <span style="color:#f92672">or</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ST2_API_VERSION</span><span style="color:#e6db74">&#39;</span>, DEFAULT_API_VERSION)

        <span style="color:#66d9ef">if</span> api_url:
            self<span style="color:#f92672">.</span>endpoints[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">api</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> api_url
</code></pre></div><p>I’m going to hinge on ‘api_url’ as an argument we can pass to the client. Let’s give it a shot and see what happens. From the NGINX config, we know that ‘/api/’ has an entry and when we run ‘st2 –debug key list’, I can also see ‘/v1’ is used as part of the URL. The ST2 client itself is helpful in terms of telling us what’s where on the API, as it uses the API directly.</p>
<p>Putting this together, I’ll hazard a guess at ‘/api/v1’ being the correct path.</p>
<p>Back to our Python shell:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">me<span style="color:#a6e22e">@testvm</span>:<span style="color:#f92672">~</span><span style="color:#960050;background-color:#1e0010">$</span> python
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">from</span> st2client.client <span style="color:#f92672">import</span> Client
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">from</span> st2client.models <span style="color:#f92672">import</span> KeyValuePair
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> client <span style="color:#f92672">=</span> Client(api_url<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">https://192.168.16.20/api/v1</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> output <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>get_all()
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">&lt;</span>Traceback snip<span style="color:#f92672">&gt;</span>
requests<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>HTTPError: <span style="color:#ae81ff">401</span> Client Error: Unauthorized
MESSAGE: Unauthorized <span style="color:#f92672">-</span> One of Token <span style="color:#f92672">or</span> API key required<span style="color:#f92672">.</span>
</code></pre></div><p>Ok, we need to pass in an API key or a token! API keys are long lived and are quick and easy to test, instead of a token! Let’s generate an API key on the ST2 client and see what we need to pass in to the Client class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">user@st2:~$ st2 apikey create
+------------+--------------------------------------------------------------+
| Property   | Value                                                        |
+------------+--------------------------------------------------------------+
| id         | 58b40f0cc4da5f072866a1bc                                     |
| created_at | 2017-02-27T11:35:40.606623Z                                  |
| enabled    | True                                                         |
| key        | NjM0OTMzNzc4YzYyMjI1ZDliOWZjYTVmYjU3MWRlMGM5N2JlNDhkZDc0N2M1 |
|            | ZjNlNTFiYzE2MTE5NzhhYTJhYg                                   |
| metadata   |                                                              |
| uid        | api_key:0ac3e2e47360928159839a0b5dbf2685f22aac71b4f3b6127ccb |
|            | 2b5b4d08715dca9070cd13e20fd5de829534271c655f622eb85cbb3cf3f0 |
|            | 469da0f161e32072                                             |
| user       | st2admin                                                     |
+------------+--------------------------------------------------------------+
</code></pre></div><p>How do we pass the API key in to the Client? Let’s hack.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;&gt;&gt; dir<span style="color:#f92672">(</span>client<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;__class__&#39;</span>, <span style="color:#e6db74">&#39;__delattr__&#39;</span>, <span style="color:#e6db74">&#39;__dict__&#39;</span>, <span style="color:#e6db74">&#39;__doc__&#39;</span>, <span style="color:#e6db74">&#39;__format__&#39;</span>, <span style="color:#e6db74">&#39;__getattribute__&#39;</span>, <span style="color:#e6db74">&#39;__hash__&#39;</span>, <span style="color:#e6db74">&#39;__init__&#39;</span>, <span style="color:#e6db74">&#39;__module__&#39;</span>, <span style="color:#e6db74">&#39;__new__&#39;</span>, <span style="color:#e6db74">&#39;__reduce__&#39;</span>, <span style="color:#e6db74">&#39;__reduce_ex__&#39;</span>, <span style="color:#e6db74">&#39;__repr__&#39;</span>, <span style="color:#e6db74">&#39;__setattr__&#39;</span>, <span style="color:#e6db74">&#39;__sizeof__&#39;</span>, <span style="color:#e6db74">&#39;__str__&#39;</span>, <span style="color:#e6db74">&#39;__subclasshook__&#39;</span>, <span style="color:#e6db74">&#39;__weakref__&#39;</span>, <span style="color:#e6db74">&#39;actions&#39;</span>, <span style="color:#e6db74">&#39;api_key&#39;</span>, <span style="color:#e6db74">&#39;apikeys&#39;</span>, <span style="color:#e6db74">&#39;cacert&#39;</span>, <span style="color:#e6db74">&#39;debug&#39;</span>, <span style="color:#e6db74">&#39;endpoints&#39;</span>, <span style="color:#e6db74">&#39;keys&#39;</span>, <span style="color:#e6db74">&#39;liveactions&#39;</span>, <span style="color:#e6db74">&#39;managers&#39;</span>, <span style="color:#e6db74">&#39;packs&#39;</span>, <span style="color:#e6db74">&#39;policies&#39;</span>, <span style="color:#e6db74">&#39;policytypes&#39;</span>, <span style="color:#e6db74">&#39;ruleenforcements&#39;</span>, <span style="color:#e6db74">&#39;rules&#39;</span>, <span style="color:#e6db74">&#39;runners&#39;</span>, <span style="color:#e6db74">&#39;sensors&#39;</span>, <span style="color:#e6db74">&#39;token&#39;</span>, <span style="color:#e6db74">&#39;tokens&#39;</span>, <span style="color:#e6db74">&#39;trace&#39;</span>, <span style="color:#e6db74">&#39;triggerinstances&#39;</span>, <span style="color:#e6db74">&#39;triggertypes&#39;</span><span style="color:#f92672">]</span>
</code></pre></div><p>We can see here the ‘api_key’ field. We could assume that as a good practice the core devs will allow us to pass in key word (kwarg) argument to the base Client class, but let’s check.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">me<span style="color:#a6e22e">@testvm</span>:<span style="color:#f92672">~</span><span style="color:#960050;background-color:#1e0010">$</span> cat <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>local<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#f92672">.</span><span style="color:#ae81ff">7</span><span style="color:#f92672">/</span>dist<span style="color:#f92672">-</span>packages<span style="color:#f92672">/</span>st2client<span style="color:#f92672">/</span>client<span style="color:#f92672">.</span>py
<span style="color:#75715e"># Licensed to the StackStorm, Inc (&#39;StackStorm&#39;) under one or more</span>
<span style="color:#75715e"># contributor license agreements.  See the NOTICE file distributed with</span>
<span style="color:#75715e"># this work for additional information regarding copyright ownership.</span>
<span style="color:#75715e"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span style="color:#75715e"># (the &#34;License&#34;); you may not use this file except in compliance with</span>
<span style="color:#75715e"># the License.  You may obtain a copy of the License at</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># Unless required by applicable law or agreed to in writing, software</span>
<span style="color:#75715e"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
<span style="color:#75715e"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span style="color:#75715e"># See the License for the specific language governing permissions and</span>
<span style="color:#75715e"># limitations under the License.</span>

<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> logging

<span style="color:#f92672">import</span> six

<span style="color:#f92672">from</span> st2client <span style="color:#f92672">import</span> models
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> ResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> ActionAliasResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> LiveActionResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> TriggerInstanceResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> PackResourceManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> ConfigManager
<span style="color:#f92672">from</span> st2client.models.core <span style="color:#f92672">import</span> StreamManager


LOG <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(__name__)

<span style="color:#75715e"># Default values for the options not explicitly specified by the user</span>
DEFAULT_API_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">9101</span>
DEFAULT_AUTH_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">9100</span>
DEFAULT_STREAM_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">9102</span>

DEFAULT_BASE_URL <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://127.0.0.1</span><span style="color:#e6db74">&#39;</span>
DEFAULT_API_VERSION <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">v1</span><span style="color:#e6db74">&#39;</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Client</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, base_url<span style="color:#f92672">=</span>None, auth_url<span style="color:#f92672">=</span>None, api_url<span style="color:#f92672">=</span>None, stream_url<span style="color:#f92672">=</span>None,
                 api_version<span style="color:#f92672">=</span>None, cacert<span style="color:#f92672">=</span>None, debug<span style="color:#f92672">=</span>False, token<span style="color:#f92672">=</span>None, api_key<span style="color:#f92672">=</span>None):
        <span style="color:#75715e"># Get CLI options. If not given, then try to get it from the environment.</span>
        self<span style="color:#f92672">.</span>endpoints <span style="color:#f92672">=</span> dict()

        <span style="color:#75715e"># Populate the endpoints</span>
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">&lt;</span>snip<span style="color:#f92672">&gt;</span>
        <span style="color:#66d9ef">if</span> api_key:
            os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ST2_API_KEY</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> api_key

        self<span style="color:#f92672">.</span>api_key <span style="color:#f92672">=</span> api_key
</code></pre></div><p>Behold! It seems we can pass in the api_key as a key word argument, but it could also be set as an environmental variable. Let’s keep this simple and pass it in to the <strong>init</strong> function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;&gt;&gt; from st2client.client import Client
&gt;&gt;&gt; from st2client.models import KeyValuePair
&gt;&gt;&gt;
&gt;&gt;&gt; client <span style="color:#f92672">=</span> Client<span style="color:#f92672">(</span>api_key<span style="color:#f92672">=</span>API_KEY, api_url<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://192.168.16.20/api/v1&#39;</span><span style="color:#f92672">)</span>
Traceback <span style="color:#f92672">(</span>most recent call last<span style="color:#f92672">)</span>:
  File <span style="color:#e6db74">&#34;&lt;stdin&gt;&#34;</span>, line 1, in &lt;module&gt;
NameError: name <span style="color:#e6db74">&#39;API_KEY&#39;</span> is not defined
&gt;&gt;&gt;
&gt;&gt;&gt; API_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NjM0OTMzNzc4YzYyMjI1ZDliOWZjYTVmYjU3MWRlMGM5N2JlNDhkZDc0N2M1ZjNlNTFiYzE2MTE5NzhhYTJhYg&#39;</span>
&gt;&gt;&gt;
&gt;&gt;&gt; client <span style="color:#f92672">=</span> Client<span style="color:#f92672">(</span>api_key<span style="color:#f92672">=</span>API_KEY, api_url<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://192.168.16.20/api/v1&#39;</span><span style="color:#f92672">)</span>
&gt;&gt;&gt;
&gt;&gt;&gt; client.keys.get_all<span style="color:#f92672">(</span><span style="color:#f92672">)</span>
<span style="color:#f92672">[</span><span style="color:#f92672">]</span>
</code></pre></div><p>Seems to have worked. See the empty list? Let’s now create a key and test for it’s presence!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt;&gt;&gt; client.keys.update<span style="color:#f92672">(</span>KeyValuePair<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;testkey&#39;</span>, value<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;testvalue&#39;</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span>
&lt;KeyValuePair name<span style="color:#f92672">=</span>testkey,value<span style="color:#f92672">=</span>testvalue&gt;
&gt;&gt;&gt; client.keys.get_all<span style="color:#f92672">(</span><span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>&lt;KeyValuePair name<span style="color:#f92672">=</span>testkey,value<span style="color:#f92672">=</span>testvalue&gt;<span style="color:#f92672">]</span>
</code></pre></div><p>Success! The code below is a working proof-of-concept example of how to create and get keys and values over the ST2 REST API using the Python <code>st2client</code>.</p>
<p>This code does not involve any error checking. What would that look like? Let’s be a good citizen and screw up our known working code and add in a ‘try except’ block.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">from st2client.client import Client
from st2client.models import KeyValuePair

API_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NjM0OTMzNzc4YzYyMjI1ZDliOWZjYTVmYjU3MWRlMGM5N2JlNDhkZDc0N2M1ZjNlNTFiYzE2MTE5NzhhYTJhYg&#39;</span>

client <span style="color:#f92672">=</span> Client<span style="color:#f92672">(</span>api_key<span style="color:#f92672">=</span>API_KEY, api_url<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://192.168.16.20/api/v2000&#39;</span><span style="color:#f92672">)</span>

try:
    client.keys.get_all<span style="color:#f92672">(</span><span style="color:#f92672">)</span>
except Exception as e:
    exit<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>
</code></pre></div><p>From here, in your except block you could print a message, exit silently or perhaps even throw an event to StackStorm!</p>
<p>Working code from this hacking session below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> st2client.client <span style="color:#f92672">import</span> Client
<span style="color:#f92672">from</span> st2client.models <span style="color:#f92672">import</span> KeyValuePair

API_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&lt;INSERT_YOUR_API_KEY_HERE&gt;</span><span style="color:#e6db74">&#39;</span>
API_URL <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&lt;https://192.168.16.20/api/v1&gt;</span><span style="color:#e6db74">&#39;</span>

client <span style="color:#f92672">=</span> Client(api_url<span style="color:#f92672">=</span>API_URL, api_key<span style="color:#f92672">=</span>API_KEY)

<span style="color:#66d9ef">try</span>:
    client<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>update(KeyValuePair(name<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">testkey</span><span style="color:#e6db74">&#39;</span>, value<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">testvalue</span><span style="color:#e6db74">&#39;</span>))

    keys <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>get_all()

    <span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> keys:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Key :</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> str(k<span style="color:#f92672">.</span>name)
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Value: </span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> str(k<span style="color:#f92672">.</span>value)

<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
    exit(<span style="color:#ae81ff">1</span>)
</code></pre></div><p>In this post we’ve exercised some basic Python skills in order to satisfy the set of light requirements. Hopefully for those of you wondering ‘how the hell do I begin this stuff?’, the logic in this post might help with your adventures!</p>
<p>Until the next time, have fun!</p>

		Dave
            </div>
        </div>
    </div>
</section>


        </div><!-- Footer Start -->
<footer id="footer" class="bg-one">
    <div class="top-footer">
        <div class="container">
            <div class="row">
                <div class="col-sm-3 col-md-3 col-lg-3">
		    <h3>Email Me</h3>
		    <a href="mailto:me@dave.dev">me@dave.dev</a>
		</div>
                <div class="col-sm-3 col-md-3 col-lg-3">
                    <h3>Social Links</h3>
                    <ul class="list-inline social-icon">
                        
                        
                        <li class="list-inline-item">
                            <a href="https://twitter.com/_ipengineer">
                                <i class="tf-ion-social-twitter"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://www.linkedin.com/in/lsp42/">
                                <i class="tf-ion-social-linkedin"></i>
                            </a>
                        </li>
                        
                        
                        
                        
                        <li class="list-inline-item">
                            <a href="https://github.com/davidjohngee">
                                <i class="tf-ion-social-github"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://github.com/arsonistgopher">
                                <i class="tf-ion-social-github"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://github.com/davedotdev">
                                <i class="tf-ion-social-github"></i>
                            </a>
                        </li>
                        
                    </ul>
                </div>
                <div class="col-sm-3 col-md-3 col-lg-3">
                    <h3>Treat the Author</h3>
		        <a href="https://www.buymeacoffee.com/ipengineer"><img border="0" alt="Buy me a coffee!" src="/images/bmac.png"></a>
                </div>
                <div class="col-sm-3 col-md-3 col-lg-3">
                    <h3>Copyright</h3>
                    <p>© David Gee and dave.dev, 2019.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- end footer -->


<!-- Essential Scripts -->

<!-- jQuery -->
<script src="https://dave.dev/plugins/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="https://dave.dev/plugins/bootstrap/dist/js/popper.min.js"></script>
<script src="https://dave.dev/plugins/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- Parallax -->
<script src="https://dave.dev/plugins/parallax/jquery.parallax-1.1.3.js"></script>
<!-- lightbox -->
<script src="https://dave.dev/plugins/lightbox2/dist/js/lightbox.min.js"></script>
<!-- Slick Carousel -->
<script src="https://dave.dev/plugins/slick-carousel/slick/slick.min.js"></script>
<!-- Portfolio Filtering -->
<script src="https://dave.dev/plugins/filterzr/jquery.filterizr.min.js"></script>
<!-- Smooth Scroll js -->
<script src="https://dave.dev/plugins/smooth-scroll/dist/js/smooth-scroll.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCC72vZw-6tGqFyRhhg5CkF2fqfILn2Tsw"></script>
<!-- Main Script -->

<script src="https://dave.dev/js/script.min.js"></script>
</body>
</html>
