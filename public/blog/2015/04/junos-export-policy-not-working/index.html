<!DOCTYPE html>
<html class="no-js" lang="en-us"><head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="Junos Export Policy Not Working?">

<meta name="generator" content="Hugo 0.62.0-DEV" />

<title>Welcome to dave.dev</title>

<!-- Mobile Specific Meta -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Favicon -->
<link rel="shortcut icon" type="image/x-icon" href="https://dave.dev/images/favicon.ico" />

<!-- Stylesheets -->
<!-- Themefisher Icon font -->
<link rel="stylesheet" href="https://dave.dev/plugins/themefisher-font/style.css">
<!-- bootstrap.min css -->
<link rel="stylesheet" href="https://dave.dev/plugins/bootstrap/dist/css/bootstrap.min.css">
<!-- Lightbox.min css -->
<link rel="stylesheet" href="https://dave.dev/plugins/lightbox2/dist/css/lightbox.min.css">
<!-- Slick Carousel -->
<link rel="stylesheet" href="https://dave.dev/plugins/slick-carousel/slick/slick.css">
<link rel="stylesheet" href="https://dave.dev/plugins/slick-carousel/slick/slick-theme.css">
<!-- Main Stylesheet -->


<link rel="stylesheet" href="https://dave.dev/css/style.min.css" integrity="" media="screen">

</head>
<body id="body">
        <!-- Start Preloader -->
<div id="preloader">
    <div class="preloader">
        <div class="sk-circle1 sk-child"></div>
        <div class="sk-circle2 sk-child"></div>
        <div class="sk-circle3 sk-child"></div>
        <div class="sk-circle4 sk-child"></div>
        <div class="sk-circle5 sk-child"></div>
        <div class="sk-circle6 sk-child"></div>
        <div class="sk-circle7 sk-child"></div>
        <div class="sk-circle8 sk-child"></div>
        <div class="sk-circle9 sk-child"></div>
        <div class="sk-circle10 sk-child"></div>
        <div class="sk-circle11 sk-child"></div>
        <div class="sk-circle12 sk-child"></div>
    </div>
</div>
<!-- End Preloader --><!-- Fixed Navigation -->


<section class="header navigation">

    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <nav class="navbar navbar-expand-md">
                    <a class="navbar-brand" href="https://dave.dev/">
                        <img src="https://dave.dev/images/logo2.png" alt="logo">
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
                        aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="tf-ion-android-menu"></span>
                    </button>
                    
                    <div id="drapeaux">
                        
                        
                    </div>
                    <div class="collapse navbar-collapse" id="navigation">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link"
                                    href="https://dave.dev/"></a>
                            </li>
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/blog">Blog</a>
                            </li>
                            
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/portfolio">Portfolio</a>
                            </li>
                            
                            
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://dave.dev/list">Full List</a>
                            </li>
                            
                            
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</section><div id="content">

<section class="blog-single section">
    <div class="container">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <img src="https://dave.dev/images/blog/placeholder.jpg" class="w-100 mb-3" alt="Post-Image">
                <h2>Junos Export Policy Not Working?</h2>
                <div class="post-meta mb-5">
                    <ul class="list-inline">
                        <li class="list-inline-item">
                            <span>By</span>
                            David Gee
                        </li>
                        <li class="list-inline-item">
                            <span>at</span>
                            <span>April 20, 2015</span>
                        </li>
                    </ul>
                </div>
                <p>During a project recently, I was promptly reminded about the construction of clean Junos route export (i.e. route redistribution) policies. Specifically when filtering prefixes during the export/redistribution. The logic goes something like this:</p>
<ol>
<li>Create prefix-list of prefixes to export</li>
<li>Create policy which references the protocol and prefix list to export</li>
<li>Attach policy to protocol</li>
</ol>
<p>An example is here:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">policy-options <span style="color:#f92672">{</span>
    prefix-list CUST_A <span style="color:#f92672">{</span>
        192.0.2.1/32;
    <span style="color:#f92672">}</span>

	policy-statement REDISTRIBUTE_STATICS_CUST_A <span style="color:#f92672">{</span>
    	/* FROM PREFIX-LIST TEST TO METRIC TYPE <span style="color:#ae81ff">1</span> FOR CUST A */
    	term <span style="color:#ae81ff">1</span> <span style="color:#f92672">{</span>
        	from <span style="color:#f92672">{</span>
            	prefix-list CUST_A;
        	<span style="color:#f92672">}</span>
        	to protocol ospf;
        	<span style="color:#66d9ef">then</span> <span style="color:#f92672">{</span>
            	external <span style="color:#f92672">{</span>
                	type 1;
            	<span style="color:#f92672">}</span>
            	accept;
        	<span style="color:#f92672">}</span>
    	<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

protocols <span style="color:#f92672">{</span>
	ospf <span style="color:#f92672">{</span>
		export REDISTRIBUTE_STATICS_CUST_A
		area 0.0.0.0 <span style="color:#f92672">{</span>
		interface x-x/x/x.x
		<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>With Junos export policies for routing, if you want to export more prefixes of the same type, you can add another policy and add it to the export line. <del>adding an additional policy which also references the same protocol for the export will just not work. If you do the below, then you’re out of luck</del> (Looks like I may have ran in to a bug with my original couple of attempts. It did work on attempt 3 on a different platform and more recent version of code. Not the first time this will happen and not the last! Thanks to ‘oldcreek’ for making me hit this again and making me question the logic).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">policy-options <span style="color:#f92672">{</span>
    prefix-list CUST_A <span style="color:#f92672">{</span>
        192.0.2.1/32;
    <span style="color:#f92672">}</span>

    prefix-list CUST_B <span style="color:#f92672">{</span>
        192.0.2.2/32;
    <span style="color:#f92672">}</span>

	policy-statement REDISTRIBUTE_STATICS_CUST_A <span style="color:#f92672">{</span>
    	/* FROM PREFIX-LIST TEST TO METRIC TYPE <span style="color:#ae81ff">1</span> FOR CUST A */
    	term <span style="color:#ae81ff">1</span> <span style="color:#f92672">{</span>
        	from <span style="color:#f92672">{</span>
            	prefix-list CUST_A;
        	<span style="color:#f92672">}</span>
        	to protocol ospf;
        	<span style="color:#66d9ef">then</span> <span style="color:#f92672">{</span>
            	external <span style="color:#f92672">{</span>
                	type 1;
            	<span style="color:#f92672">}</span>
            	accept;
        	<span style="color:#f92672">}</span>
    	<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
	policy-statement REDISTRIBUTE_STATICS_CUST_B <span style="color:#f92672">{</span>
    	/* FROM PREFIX-LIST TEST TO METRIC TYPE <span style="color:#ae81ff">1</span> FOR CUST B */
    	term <span style="color:#ae81ff">1</span> <span style="color:#f92672">{</span>
        	from <span style="color:#f92672">{</span>
            	prefix-list CUST_B;
        	<span style="color:#f92672">}</span>
        	to protocol ospf;
        	<span style="color:#66d9ef">then</span> <span style="color:#f92672">{</span>
            	external <span style="color:#f92672">{</span>
                	type 1;
            	<span style="color:#f92672">}</span>
            	accept;
        	<span style="color:#f92672">}</span>
    	<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

protocols <span style="color:#f92672">{</span>
	ospf <span style="color:#f92672">{</span>
		export <span style="color:#f92672">[</span>REDISTRIBUTE_STATICS_CUST_A REDISTRIBUTE_STATICS_CUST_B<span style="color:#f92672">]</span>
		area 0.0.0.0 <span style="color:#f92672">{</span>
		interface x-x/x/x.x
		<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>It gets the job done, but looks awfully clumsy.</p>
<h4 id="the-bucket-list-methodology">The bucket list methodology</h4>
<p>When exporting prefixes originating from aggregates, statics, IGPs and BGP to something else, you could use the ‘bucket list’ method of dealing with prefixes to redistribute in to a routing protocol.</p>
<p>This bucket list method involves imagining walking up to a bucket and picking out several lists worth of items from the said bucket. Once you have all of the items, move on to the next bucket and repeat. The idea is you visit each in sequence without ever returning to a bucket previously visited.</p>
<p>Translating this to Junos, this logic will allow you to constantly add prefixes you want to export without breaking the logic or making a messs of your policy.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">policy-options <span style="color:#f92672">{</span>
    prefix-list CUST_A <span style="color:#f92672">{</span>
        192.0.2.1/32;
    <span style="color:#f92672">}</span>

    prefix-list CUST_B <span style="color:#f92672">{</span>
        192.0.2.2/32;
    <span style="color:#f92672">}</span>
	
	policy-statement REDISTRIBUTE_STATICS_TO_OSPF_GLOBAL <span style="color:#f92672">{</span>
    	/* FROM PREFIX-LIST CUST_A TO OSPF TYPE <span style="color:#ae81ff">1</span> */
    	term <span style="color:#ae81ff">1</span> <span style="color:#f92672">{</span>
    	    from <span style="color:#f92672">{</span>
    	        prefix-list CUST_A;
    	    <span style="color:#f92672">}</span>
    	    to protocol ospf2;
    	    <span style="color:#66d9ef">then</span> <span style="color:#f92672">{</span>
    	        external <span style="color:#f92672">{</span>
    	            type 1;
    	        <span style="color:#f92672">}</span>
    	        accept;
    	    <span style="color:#f92672">}</span>
    	<span style="color:#f92672">}</span>
    	/* FROM PREFIX-LIST CUST_B TO OSPF TYPE <span style="color:#ae81ff">1</span> */
    	term <span style="color:#ae81ff">2</span> <span style="color:#f92672">{</span>
    	    from <span style="color:#f92672">{</span>
     	       prefix-list CUST_B;
    	    <span style="color:#f92672">}</span>
    	    to protocol ospf2;
    	    <span style="color:#66d9ef">then</span> <span style="color:#f92672">{</span>
    	        external <span style="color:#f92672">{</span>
    	            type 1;
    	        <span style="color:#f92672">}</span>
    	        accept;
    	    <span style="color:#f92672">}</span>
    	<span style="color:#f92672">}</span>
    	/* FROM PROTOCOL STATIC - REFERENCE ONCE! */
    	from protocol static;
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

protocols <span style="color:#f92672">{</span>
	ospf <span style="color:#f92672">{</span>
		export REDISTRIBUTE_STATICS_TO_OSPF_GLOBAL
		area 0.0.0.0 <span style="color:#f92672">{</span>
		interface x-x/x/x.x
		<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>When dealing with a network operating system like Cisco IOS, you create a redistribute statement and then attach various controls to the statement in order to control what you redistribute into another protocol (assuming you wanted to control it!). The redistribute statement is a single entity and add the policy is expanded to redistribute further prefixes. The difference with Junos is policies can be added to the export statement, but the result is it doesn’t work the way you think it does if the multiple policies references the same ‘from protocol’ statement.</p>
<p>For what it’s worth, take care with redistribution. Unless you have modelled what you want to do, most of the time redistributing isn’t actually what you want to do. This is especially true when including interfaces in a routing protocol. Don’t redistribute when you have better knobs to tweak and it’s worth reviewing the different ways you can architect scenarios for multiple interactions between protocols and types of routes. Running two OSPF processes next to each other is better than trying to filter LSAs between interfaces. Some routers need to see two different OSPF domains. A likely scenario for that of a managed services provider.</p>
<p>In summary, go to the bucket, pick from it your list and move to the next bucket.</p>
<h4 id="taking-it-further">Taking it further</h4>
<p>When you think about larger scale routing domains, think in terms of all of the moving parts. Having a set of routing policies that exist on every template configuration will help to remove clunky policies like this and reduce the time wasted. Your brain automatically will be reminded to think the right way and routing policies will become simpler. Replace TABLE with whatever routing table this policy is for. In my example above it was the standard global table.</p>
<p>REDISTRIBUTE_STATICS_TO_OSPF_TABLE
REDISTRIBUTE_BGP_TO_OSPF_TABLE
REDISTRIBUTE_AGGREGATES_TO_BGP_TABLE</p>
<p>Final tidbit, remember you can place annotations into Junos using the</p>
<p><code>annotate</code></p>
<p>syntax which results in the</p>
<p><code>/* COMMENT */</code></p>
<p>annotations within Junos config.</p>

		Dave
            </div>
        </div>
    </div>
</section>


        </div><!-- Footer Start -->
<footer id="footer" class="bg-one">
    <div class="top-footer">
        <div class="container">
            <div class="row">
                <div class="col-sm-3 col-md-3 col-lg-3">
		    <h3>Email Me</h3>
		    <a href="mailto:me@dave.dev">me@dave.dev</a>
		</div>
                <div class="col-sm-3 col-md-3 col-lg-3">
                    <h3>Social Links</h3>
                    <ul class="list-inline social-icon">
                        
                        
                        <li class="list-inline-item">
                            <a href="https://twitter.com/_ipengineer">
                                <i class="tf-ion-social-twitter"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://www.linkedin.com/in/lsp42/">
                                <i class="tf-ion-social-linkedin"></i>
                            </a>
                        </li>
                        
                        
                        
                        
                        <li class="list-inline-item">
                            <a href="https://github.com/davidjohngee">
                                <i class="tf-ion-social-github"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://github.com/arsonistgopher">
                                <i class="tf-ion-social-github"></i>
                            </a>
                        </li>
                        
                        
                        <li class="list-inline-item">
                            <a href="https://github.com/davedotdev">
                                <i class="tf-ion-social-github"></i>
                            </a>
                        </li>
                        
                    </ul>
                </div>
                <div class="col-sm-3 col-md-3 col-lg-3">
                    <h3>Treat the Author</h3>
		        <a href="https://www.buymeacoffee.com/ipengineer"><img border="0" alt="Buy me a coffee!" src="/images/bmac.png"></a>
                </div>
                <div class="col-sm-3 col-md-3 col-lg-3">
                    <h3>Copyright</h3>
                    <p>© David Gee and dave.dev, 2019.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- end footer -->


<!-- Essential Scripts -->

<!-- jQuery -->
<script src="https://dave.dev/plugins/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="https://dave.dev/plugins/bootstrap/dist/js/popper.min.js"></script>
<script src="https://dave.dev/plugins/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- Parallax -->
<script src="https://dave.dev/plugins/parallax/jquery.parallax-1.1.3.js"></script>
<!-- lightbox -->
<script src="https://dave.dev/plugins/lightbox2/dist/js/lightbox.min.js"></script>
<!-- Slick Carousel -->
<script src="https://dave.dev/plugins/slick-carousel/slick/slick.min.js"></script>
<!-- Portfolio Filtering -->
<script src="https://dave.dev/plugins/filterzr/jquery.filterizr.min.js"></script>
<!-- Smooth Scroll js -->
<script src="https://dave.dev/plugins/smooth-scroll/dist/js/smooth-scroll.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCC72vZw-6tGqFyRhhg5CkF2fqfILn2Tsw"></script>
<!-- Main Script -->

<script src="https://dave.dev/js/script.min.js"></script>
</body>
</html>
